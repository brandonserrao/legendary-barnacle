<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
        
        <title>Testing Map for WiOutside</title>
        
        <!-- Leaflet -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
              integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
              crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
                 integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
                 crossorigin=""></script>

        <!-- PapaParse -->
        <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
        
        <style>
            body {
                padding: 0;
                margin: 0;
            }
            html, body, #mapid{
                height: 100%;
                width: 100vw;
            }
        </style>
    </head>
    
    <body>
        
        <!-- Load in constants-->
        <script type="text/javascript" src="constants.js"></script>
        
        <!-- Map container-->
        <div id='mapid'></div>
        <!-- Map script-->
        <script>
            
            //init map variable//
            var myMap = L.map('mapid').setView([0,0], 2)
            //add map layer the map via methods//
            var OpenStreetMap_Mapnik = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            });
            
            var Stamen_TonerBackground = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner-background/{z}/{x}/{y}{r}.{ext}', {
                attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                subdomains: 'abcd',
                minZoom: 0,
                maxZoom: 20,
                ext: 'png'
            });
            
            //Stamen_TonerBackground.addTo(myMap);
            OpenStreetMap_Mapnik.addTo(myMap);
            
            var personData;
            var personLayer = L.geoJSON().addTo(myMap);
            
            //FUNCTION DEFINITIONS
            function storePersonData(data) { //to bind the data pulled in into the variable
                console.log('stored personData');
                personData = data;
            }


            console.log('reaching fetch api testing')
            var apiUrl = 'https://sheets.googleapis.com/v4/spreadsheets/'
            var spreadsheetId = googleDocURL.indexOf('/d/') > 0
            ? googleDocURL.split('/d/')[1].split('/')[0]
            : googleDocURL
            var headers;
            
                  
            //taken from Chaining Promises https://developers.google.com/web/updates/2015/03/introduction-to-fetch
            function status(response) {
              if (response.status >= 200 && response.status < 300) {
                return Promise.resolve(response)
              } else {
                return Promise.reject(new Error(response.statusText))
              }
            }
            
            function json(response) {
              return response.json()
            }
            
            
            function toGeoJSONFeatureCollection(arrayOfRows) {//create spec-respecting collection of geojson points out of the data
                var outputGeoJSON = {"type": "FeatureCollection",
                                    "features": []
                                    };
                headers = arrayOfRows.shift(); //get rid of header row
                
                arrayOfRows.forEach(function(row) {
                    var feature = {"type": "Feature"};
                    feature["geometry"] = {"type": "Point",
                                          "coordinates": [parseFloat(row[0]), parseFloat(row[1])]};
                    feature["properties"] = {};
                    for (let i = 2; i < headers.length; i++){
                        feature["properties"][headers[i]] = row[i];
                            }
                    outputGeoJSON["features"].push(feature);
                })
                return outputGeoJSON;
                };
                
            //fetch(apiUrl + spreadsheetId + '?key=' + googleApiKey)
            fetch(apiUrl + spreadsheetId + '/values/Points?key=' + googleApiKey)
            .then(status)
            .then(json)
            .then(function(data) {
                //console.log('Request succeeded with JSON response', data);
                storePersonData(toGeoJSONFeatureCollection(data.values));
                loadData(personData, personLayer);
                //console.log(JSON.stringify(personData));
            }).catch(function(error) {
                console.log('Request failed', error);
            });
            
            function loadData(data, leafletLayer) { //TODO: ADD STYLING, POPUPBINDING ETC.
                leafletLayer.addData(data.features);
            }

    </script>
        
    </body>
</html>
