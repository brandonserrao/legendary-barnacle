<!DOCTYPE html>
<html>
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
        
        <title>Testing Map for TT Lockout Map</title>
        
        <!-- Leaflet -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
              integrity="sha512-xodZBNTC5n17Xt2atTPuE1HxjVMSvLVW9ocqUKLsCC5CXdbqCmblAshOMAS6/keqq/sMZMZ19scR4PsZChSR7A=="
              crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"
                 integrity="sha512-XQoYMqMTK8LvdxXYG3nZ448hOEQiglfqkJs1NOQV44cWnUrBc8PkAOcXy20w0vlaXaVUearIOBhiXZ5V3ynxwA=="
                 crossorigin=""></script>

        <!-- PapaParse -->
        <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
        
        <!-- leaflet-pulse-icon-->
        <script src="plugins/leaflet-icon-pulse/dist/L.Icon.Pulse.js"></script>
        <link rel="stylesheet" href="plugins/leaflet-icon-pulse/dist/L.Icon.Pulse.css"/>
        
        <!-- Leaflet.markercluster-->
        <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css"/>
        <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css"/><!--not needed if you use your own iconCreateFunction instead of this default one-->
        <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster-src.js"></script>
        
            <!--sidebar files-->
        <script src="plugins/leaflet-sidebar-v2/leaflet-sidebar.min.js"></script>
        <link rel="stylesheet" href="plugins/leaflet-sidebar-v2/leaflet-sidebar.min.css"/>

        <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
        
        
        
        <style>
            body {
                padding: 0;
                margin: 0;
            }
            html, body, #mapid{
                height: 100%;
                width: 100vw;
            }
        </style>
    </head>
    
    <body>
        
        
        <!-- Load in constants and options-->
        <script type="text/javascript" src="constants.js"></script>
        <script type="text/javascript" src="options.js"></script>
        
        <!-- Map container-->
        <div id='mapid'></div>
        <!-- Map script-->
        <script>
            
            //LEAFLET MAP CODE
            //init map variable//
            var myMap = L.map('mapid', mapOptions)//.setView([0,0], 2)

            //add map layer the map via methods//
            var OpenStreetMap_Mapnik = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                maxZoom: 19,
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            });
            
            var Stamen_TonerBackground = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/toner-background/{z}/{x}/{y}{r}.{ext}', {
                attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>, <a href="http://creativecommons.org/licenses/by/3.0">CC BY 3.0</a> &mdash; Map data &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                subdomains: 'abcd',
                minZoom: 0,
                maxZoom: 20,
                ext: 'png'
            });
            
            Stamen_TonerBackground.addTo(myMap);
            
            
            //SIDEBAR CODE
            var sidebar = L.control.sidebar().addTo(myMap);
            sidebar.addPanel(homePanelContent);
            sidebar.addPanel(githubButton);
            sidebar.addPanel(storyTickerContent);
            
            //MAP MARKER AND DATA FETCHING CODE
            var pulseIcon = L.icon.pulse(pulseIconOptions);
            var pulseIcon2 = L.icon.pulse(pulseIconOptions2);
                        
            var personData;
            var personLayer = L.geoJSON(null,{
                                        //pointToLayer: pointToLayer, //default is to spawn a ddefault Marker a la function(geoJson, latlng) {return L.marker(latlng);}
                                        style: styleFunction,
                                        onEachFeature: onEachFeature,
                                        });
            var markers = L.markerClusterGroup(clusterMarkerOptions);
            
            //FUNCTION DEFINITIONS
            //bind the data pulled in into the data variable
            function storePersonData(data) {
                console.log('stored personData');
                personData = data;
            }


            console.log('reaching fetch api testing')
            var apiUrl = 'https://sheets.googleapis.com/v4/spreadsheets/'
            var spreadsheetId = googleDocURL.indexOf('/d/') > 0
                                    ? googleDocURL.split('/d/')[1].split('/')[0]
                                    : googleDocURL
            var headers;//container for list of sheet headers
            
                  
            //taken from Chaining Promises https://developers.google.com/web/updates/2015/03/introduction-to-fetch
            
            function status(response) {
              if (response.status >= 200 && response.status < 300) {
                return Promise.resolve(response)
              } else {
                return Promise.reject(new Error(response.statusText))
              }
            }
            
            function json(response) {
              return response.json()
            }
            
            //construct geojson out of array of data from the google sheet
            function toGeoJSONFeatureCollection(arrayOfRows) {//create spec-respecting collection of geojson points out of the data
                var outputGeoJSON = {"type": "FeatureCollection",
                                    "features": []
                                    };
                headers = arrayOfRows.shift(); //get rid of header row
                
                arrayOfRows.forEach(function(row) {
                    var feature = {"type": "Feature"};
                    feature["geometry"] = {"type": "Point",
                                          "coordinates": [parseFloat(row[0]), parseFloat(row[1])]};
                    feature["properties"] = {};
                    for (let i = 2; i < headers.length; i++){
                        feature["properties"][headers[i]] = row[i];
                            }
                    outputGeoJSON["features"].push(feature);
                })
                return outputGeoJSON;
                };
                
            
            //fetch(apiUrl + spreadsheetId + '?key=' + googleApiKey)
            fetch(apiUrl + spreadsheetId + '/values/Points?key=' + googleApiKey)
            .then(status)
            .then(json)
            .then(function(data) {
                //console.log('Request succeeded with JSON response', data);
                storePersonData(toGeoJSONFeatureCollection(data.values));
                loadData(personData, personLayer);
                //console.log(JSON.stringify(personData));
            }).catch(function(error) {
                console.log('Request failed', error);
            });
            
            //
            function loadData(data, leafletLayer) {
                leafletLayer.addData(data.features);
                
                markers.addLayer(leafletLayer);
                markers.eachLayer(function (layer) {
                    layer.setIcon(pulseIcon2);
                });
                myMap.addLayer(markers);
                myMap.fitBounds(markers.getBounds());
                //leafletLayer.addTo(myMap);
            }

        
        //testing functions
            
        function pointToLayer(feature, latlng) {
            return L.circleMarker(latlng, {
                        radius: 8,
                        weight: 1,
                        fillOpacity: 1,
                        fillColor: 'blue',
                        color: 'black'
                    })
        }
        
        //obsoleted - was being used to affect the markers drawn by the geojson layer; markers now drawn by clustermakerlayer (var markers) and appearance controlled by options.js 
        function styleFunction(feature) { 
            switch (feature.properties.status) {
                case 'waiting': return {fillColor: 'red'};
                case 'granted': return {fillColor: 'green'};
            }
        }
        
        function onEachFeature (feature, layer) {
            let outputString = '';
            outputString += '<b>' + feature.properties.status + '</b>';
            //console.log(feature);
            layer.bindPopup(outputString);
        }
            

    </script>
        
    </body>
</html>